{"version":3,"sources":["../../../src/sqlite/statements/TableStatementCreator.js"],"names":["TableStatementCreator","constructor","schema","createTableStatement","tableStatementCreator","createDropTableStatement","getTableName","SqliteUtils","escapeName","SchemaUtils","getTableNameFromSchema","removeNullOrEmptyStrings","expression","filter","part","length","validateSchema","SchemaValidator","validate","createPrimaryKeysExpression","keys","primaryKeys","map","column","join","createUniqueExpressions","Array","isArray","unique","uniqueExpression","UniqueExpressionCreator","createExpression","createForeignKeysExpression","foreignKeys","Object","name","columnName","source","sourceColumn","push","createColumnsExpression","cleanedExpression","sql","values","createDropTableStatment","createColumnExpression","type","isRequired","defaultValue","sqlizeValue","createIndexStatements","statement","columns","isIndexed","isUnique","tableName"],"mappings":"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","sourcesContent":["import SchemaUtils from \"../utils/SchemaUtils\";\nimport SqliteUtils from \"../utils/SqliteUtils\";\nimport UniqueExpressionCreator from \"./UniqueExpressionCreator\";\nimport SchemaValidator from \"../SchemaValidator\";\n\nexport default class TableStatementCreator {\n    constructor(schema) {\n        this.schema = schema;\n    }\n\n    static createTableStatement(schema) {\n        const tableStatementCreator = new TableStatementCreator(schema);\n        return tableStatementCreator.createTableStatement();\n    }\n\n    static createDropTableStatement() {\n        const tableStatementCreator = new TableStatementCreator(schema);\n        return tableStatementCreator.createDropTableStatement();\n    }\n\n    getTableName() {\n        return SqliteUtils.escapeName(SchemaUtils.getTableNameFromSchema(this.schema));\n    }\n\n    removeNullOrEmptyStrings(expression) {\n        return expression.filter((part) => {\n            return typeof part === \"string\" && part.length > 0;\n        });\n    }\n\n    validateSchema() {\n        return SchemaValidator.validate(this.schema);\n    }\n\n    createPrimaryKeysExpression() {\n        const keys = this.schema.primaryKeys.map((column) => {\n            return SqliteUtils.escapeName(column);\n        }).join(\", \");\n\n        return `PRIMARY KEY(${keys})`;\n    }\n\n    createUniqueExpressions() {\n        if (Array.isArray(this.schema.unique)) {\n            return this.schema.unique.map((unique) => {\n\n                const uniqueExpression = new UniqueExpressionCreator(unique);\n                return uniqueExpression.createExpression();\n\n            }).join(\", \");\n        }\n        return \"\";\n    }\n\n    createForeignKeysExpression() {\n        const foreignKeys = this.schema.foreignKeys || {};\n\n        return Object.keys(foreignKeys).map((name) => {\n            const column = foreignKeys[name];\n            const columnName = SqliteUtils.escapeName(name);\n            const source = SqliteUtils.escapeName(SchemaUtils.getTableNameFromSchema(column.source));\n            const sourceColumn = SqliteUtils.escapeName(column.source.column);\n\n            return `FOREIGN KEY (${columnName}) REFERENCES ${source} (${sourceColumn})`;\n        }).join(\", \");\n    }\n\n    createTableStatement() {\n        this.validateSchema();\n        const expression = [];\n\n        expression.push(this.createColumnsExpression());\n        expression.push(this.createPrimaryKeysExpression());\n        expression.push(this.createUniqueExpressions());\n        expression.push(this.createForeignKeysExpression());\n\n        const cleanedExpression = this.removeNullOrEmptyStrings(expression);\n\n        const sql = `CREATE TABLE IF NOT EXISTS ${this.getTableName()} (${cleanedExpression.join(\", \")})`;\n\n        return {\n            sql,\n            values: []\n        }\n    }\n\n    createDropTableStatment() {\n        const sql = `DROP TABLE IF EXISTS ${this.getTableName()}`;\n\n        return {\n            sql,\n            values: []\n        }\n    }\n\n    createColumnExpression({\n        name,\n        type,\n        isRequired,\n        defaultValue\n    }) {\n\n        const expression = [];\n        expression.push(`${SqliteUtils.escapeName(name)}`);\n\n        expression.push(type);\n\n        if (isRequired) {\n            expression.push(\"NOT NULL\");\n        }\n\n        if (defaultValue != null) {\n            expression.push(this.sqlizeValue(defaultValue));\n        }\n\n        return expression.join(\" \");\n    }\n\n    createIndexStatements() {\n        const statement = this.schema.columns.filter((column) => {\n            return column.isIndexed;\n        }).map((column) => {\n            const isUnique = column.isUnique ? \" UNIQUE \" : \" \";\n            const tableName = this.getTableName();\n            const name = SqliteUtils.escapeName(`${this.schema.name}_${column.name}`);\n\n            const columnName = SqliteUtils.escapeName(column.name);\n            return `CREATE${isUnique}INDEX IF NOT EXIST ${name} ON ${tableName}(${columnName})`;\n        });\n\n        if (statement.length > 0) {\n            return statement.join(\";\") + \";\";\n        } else {\n            return null;\n        }\n    }\n\n    createColumnsExpression() {\n        return this.schema.columns.map((column) => {\n            return this.createColumnExpression(column);\n        }).join(\", \");\n    }\n}"],"file":"TableStatementCreator.js"}